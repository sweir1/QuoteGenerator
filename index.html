<!doctype html>
<html>
    <head>
        <title>Quote Generator</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
        <script src="https://www.google.com/recaptcha/api.js?render=6Le2l9UpAAAAAAqPCVBq6hdumV0KR79KO0UPyQLR"></script>
        <style>
            .custom-file-label {
                padding: 1.5rem;
                cursor: pointer;
                border: 2px dashed #ced4da;
                border-radius: 5px;
                text-align: center;
                margin-bottom: 1rem;
                transition: border-color 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 120px;
                width: 100%;
                position: relative;
                overflow: hidden;
                background-color: #fff;
            }

            .custom-file-label:hover {
                border-color: #7f56d9;
            }

            .custom-file-label::after {
                content: "Browse";
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                z-index: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1.5rem;
                color: #495057;
                cursor: pointer;
                height: auto;
            }

            .custom-file-input {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                z-index: 2;
                width: 100%;
                height: 100%;
                opacity: 0;
                cursor: pointer;
            }

            .file-upload-container {
                margin-bottom: 1rem;
            }

            .context-label,
            .price-element {
                font-size: 1rem;
                font-weight: 600;
                color: #333;
                display: block;
                text-align: center;
                margin-top: 1.5rem;
                margin-bottom: 1rem;
                margin-top: 2.5rem;
                margin-bottom: 0.5rem;
                font-weight: bold;
                padding-top: 1rem;
            }

            .pay-button {
                display: block;
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
                color: #fff;
                background-color: #7f56d9;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s ease;
                text-align: center;
                margin-top: 10px;
            }

            .pay-button:hover {
                background-color: #6941c6;
            }
            .pay-button-loading {
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: not-allowed !important;
                padding: 1.625rem;
            }
            .loader {
                width: 100%;
                height: 4px;
                display: inline-block;
                position: relative;
                border-radius: 5px;
                background: rgba(255, 255, 255, 0.15);
                overflow: hidden;
            }
            .loader::after {
                content: '';
                width: 192px;
                height: 4px;
                border-radius: 5px;
                background: #FFF;
                position: absolute;
                top: 0;
                left: 0;
                box-sizing: border-box;
                animation: animloader 2s linear infinite;
            }

            @keyframes animloader {
                0% {
                    left: 0;
                    transform: translateX(-100%);
                }
                100% {
                    left: 100%;
                    transform: translateX(0%);
                }
            }
            .notification {
                border-radius: 10px;
                font-size: 12px;
                padding: 0 10px;
            }
        </style>
    </head>
    <body>
        <h1>Quote Generator</h1>
        <form id="uploadForm">
            <label for="turnaroundTime" class="field-label-2">Delivery Time</label>
            <select id="turnaroundTime" name="turnaroundTime" required="" class="w-select">
                <option value="48 hours">48 hours</option>
                <option value="24 hours">24 hours</option>
            </select>
            <label for="quality" class="field-label-2">Quality</label>
            <select id="quality" name="quality" required="" class="w-select">
                <option value="Generic">Generic</option>
                <option value="Business specific">Business specific</option>
            </select>

            <label for="language" class="field-label-2">Desired Language</label>
            <select id="language" name="language" data-name="language" required="" class="w-select">
                <option value="English">English</option>
                <option value="French">French</option>
                <option value="Italian">Italian</option>
                <option value="German">German</option>
                <option value="Swiss German">Swiss German</option>
                <option value="Portuguese">Portuguese</option>
                <option value="simplified Chinese">simplified Chinese</option>
                <option value="Japanese">Japanese</option>
                <option value="Arabic">Arabic</option>
            </select>

            <label for="file-upload" class="field-label-2">File Upload</label>
            <div class="file-upload-container">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="fileInput" name="file" accept=".doc,.docx,.pdf,.xls,.xlsx,.ppt,.pptx,.txt" required />
                    <label class="custom-file-label" for="fileInput">
                        <span id="fileLabel">Choose file or drag and drop</span>
                    </label>
                </div>
            </div>

            <div id="contextFileContainer" style="display: none">
                <label for="context" class="field-label-2">Context</label>
                <div class="file-upload-container">
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="contextFileInput" name="contextFile" accept=".doc,.docx,.pdf,.xls,.xlsx,.ppt,.pptx,.txt" />
                        <label class="custom-file-label" for="contextFileInput">
                            <span id="contextFileLabel">Choose context file or drag and drop</span>
                        </label>
                    </div>
                </div>
            </div>

            <label id="priceElement" class="price-element">Price: $0.00</label>
            <button id="payButton" class="pay-button" onclick="generateStripePaymentLink()">Proceed to Checkout</button>
            <div id="payButtonLoading" style="display: none;">
                <button class="pay-button pay-button-loading">
                    <span class="loader"></span>
                </button>
                <span class="notification">It may take a few minutes or longer, please do not close the browser</span>
            </div>

            <script src="https://www.google.com/recaptcha/api.js"></script>
            <script>
                const fileInput = document.getElementById("fileInput");
                const fileLabel = document.getElementById("fileLabel");
                const contextFileInput = document.getElementById("contextFileInput");
                const contextFileLabel = document.getElementById("contextFileLabel");
                const qualitySelect = document.getElementById("quality");
                const contextFileContainer = document.getElementById("contextFileContainer");
                const turnaroundTimeSelect = document.getElementById("turnaroundTime");

                // Update label text when file is selected
                fileInput.addEventListener("change", function (e) {
                    if (fileInput.files.length === 0) {
                        // No file selected, reset file label and price
                        fileLabel.textContent = "Choose file or drag and drop";
                        calculatePrice();
                    } else {
                        const fileName = e.target.files[0].name;
                        const allowedExtensions = [".doc", ".docx", ".pdf", ".xls", ".xlsx", ".ppt", ".pptx", ".txt"];
                        const fileExtension = fileName.slice(fileName.lastIndexOf(".")).toLowerCase();

                        if (allowedExtensions.includes(fileExtension)) {
                            fileLabel.textContent = fileName;
                            calculatePrice(); // Trigger price calculation when the main file is selected
                        } else {
                            fileInput.value = ""; // Clear the file input
                            fileLabel.textContent = "Choose file or drag and drop";
                            alert("Only Word, PDF, Excel, PPT, and text files are allowed.");
                        }
                    }
                });

                // Update label text when context file is selected
                contextFileInput.addEventListener("change", function (e) {
                    if (contextFileInput.files.length === 0) {
                        // No file selected, reset file label
                        contextFileLabel.textContent = "Choose context file or drag and drop";
                    } else {
                        const fileName = e.target.files[0].name;
                        const allowedExtensions = [".doc", ".docx", ".pdf", ".xls", ".xlsx", ".ppt", ".pptx", ".txt"];
                        const fileExtension = fileName.slice(fileName.lastIndexOf(".")).toLowerCase();

                        if (allowedExtensions.includes(fileExtension)) {
                            contextFileLabel.textContent = fileName;
                        } else {
                            contextFileInput.value = ""; // Clear the context file input
                            contextFileLabel.textContent = "Choose context file or drag and drop";
                            alert("Only Word, PDF, Excel, PPT, and text files are allowed.");
                        }
                    }
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    const dropZone = e.target.closest(".custom-file-label");

                    if (dropZone) {
                        const inputElement = dropZone.previousElementSibling;

                        if (files.length === 1) {
                            inputElement.files = files;
                            inputElement.dispatchEvent(new Event("change"));
                        }
                    }
                }

                const customFileLabels = document.querySelectorAll(".custom-file-label");

                customFileLabels.forEach((label) => {
                    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
                        label.addEventListener(eventName, preventDefaults, false);
                    });

                    label.addEventListener("drop", handleDrop, false);
                });

                // Show/hide context file input based on quality selection
                qualitySelect.addEventListener("change", function () {
                    if (qualitySelect.value === "Business specific") {
                        contextFileContainer.style.display = "block";
                    } else {
                        contextFileContainer.style.display = "none";
                        contextFileInput.value = ""; // Clear the context file input
                        contextFileLabel.textContent = "Choose context file or drag and drop";
                    }
                    calculatePrice(); // Trigger price calculation when quality is changed
                });

                // Component 3: Calculate price
                function calculatePrice() {
                    const form = document.getElementById("uploadForm");
                    const formData = new FormData(form);
                    const priceElement = document.getElementById("priceElement");
                    const turnaroundTimeSelect = document.getElementById("turnaroundTime");

                    if (fileInput.files.length === 0) {
                        // No file selected, reset price display
                        priceElement.textContent = "Price: $0.00";
                        return;
                    }

                    priceElement.textContent = "Calculating..."; // Show "Calculating..." message

                    fetch("/.netlify/functions/upload", {
                        method: "POST",
                        body: formData,
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error(`HTTP Error: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data.error) {
                                console.error("Backend Error:", data.error);
                                priceElement.textContent = "Error calculating price. Please try again.";
                            } else {
                                priceElement.textContent = `Price: $${data.price.toFixed(2)}`; // Display the price
                            }
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            priceElement.textContent = `An error occurred: ${error.message}. Please try again.`;
                        });
                }

                // Trigger price calculation when the turnaround time is changed
                turnaroundTimeSelect.addEventListener("change", function () {
                    calculatePrice();
                });

                // Component 2: Generate Stripe payment link
                function generateStripePaymentLink(e) {
                    e.preventDefault();

                    grecaptcha.ready(function() {
                        grecaptcha.execute('6Le2l9UpAAAAAAqPCVBq6hdumV0KR79KO0UPyQLR', { action: 'submit' }).then(function(token) {
                            const form = document.getElementById("uploadForm");
                            const formData = new FormData(form);
                            formData.append("g-recaptcha-response", token);

                            // Hide pay button
                            const payButtonEl = document.getElementById("payButton");
                            payButtonEl && (payButtonEl.style.display = 'none');
                            // Show loading button
                            const payButtonLoading = document.getElementById("payButtonLoading");
                            payButtonLoading && (payButtonLoading.style.display = 'block');

                            fetch("/.netlify/functions/create-stripe-payment", {
                                method: "POST",
                                body: formData,
                            })
                                .then((response) => response.json())
                                .then((data) => {
                                    if (data.error) {
                                        console.error("Error generating Stripe payment link:", data.error);
                                        if (data.error === 'reCAPTCHA verification failed') {
                                            alert('reCAPTCHA verification failed. Please try again.');
                                        } else {
                                            alert('An error occurred while generating the payment link. Please try again.');
                                        }
                                    } else {
                                        window.location.href = data.paymentLink;
                                    }
                                })
                                .catch((error) => {
                                    console.error("Error generating Stripe payment link:", error);
                                    alert('An error occurred while generating the payment link. Please try again.');
                                })
                                .finally(() => {
                                    // Restore the button's original state
                                    // Show pay button
                                    const payButtonEl = document.getElementById("payButton");
                                    payButtonEl && (payButtonEl.style.display = 'block');
                                    // Hide loading button
                                    const payButtonLoading = document.getElementById("payButtonLoading");
                                    payButtonLoading && (payButtonLoading.style.display = 'none');
                                });
                        });
                    });
                }

                const form = document.getElementById("uploadForm");
                form.addEventListener("submit", generateStripePaymentLink);
            </script>
        </form>
    </body>
</html>
